name: "Sync from SuperClaude Framework"

# Automated pull-sync with namespace isolation
# Syncs content from SuperClaude_Framework and transforms it for Plugin distribution
# Documentation: docs/SYNC_SYSTEM.md

on:
  schedule:
    - cron: '0 * * * *'  # Hourly sync

  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (preview changes without applying)'
        required: false
        default: false
        type: boolean

# Prevent concurrent sync runs
concurrency:
  group: sync-framework-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Sync from Framework
  sync-framework:
    name: "Sync from SuperClaude Framework"
    runs-on: ubuntu-latest

    permissions:
      contents: write      # Required for auto-commit
      pull-requests: write # Required for PR comments

    outputs:
      files-modified: ${{ steps.sync.outputs.files-modified }}
      sync-success: ${{ steps.sync.outputs.sync-success }}
      commands-transformed: ${{ steps.sync.outputs.commands-transformed }}
      agents-transformed: ${{ steps.sync.outputs.agents-transformed }}

    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git mv support
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "ðŸ Setup Python 3.11"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: "ðŸ” Validate sync script exists"
        run: |
          if [ ! -f "scripts/sync_from_framework.py" ]; then
            echo "âŒ Error: scripts/sync_from_framework.py not found"
            exit 1
          fi
          echo "âœ… Sync script found"

      - name: "ðŸ”„ Run sync script"
        id: sync
        run: |
          echo "ðŸš€ Starting Framework sync..."

          # Build command with optional dry-run flag
          SYNC_CMD="python scripts/sync_from_framework.py \
            --framework-repo https://github.com/SuperClaude-Org/SuperClaude_Framework \
            --plugin-root . \
            --output-report sync-report.json"

          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "ðŸ” Running in DRY RUN mode (no files will be modified)"
            SYNC_CMD="$SYNC_CMD --dry-run"
          fi

          # Run sync script
          if $SYNC_CMD; then
            echo "sync-success=true" >> $GITHUB_OUTPUT
            echo "âœ… Sync script completed successfully"
          else
            echo "sync-success=false" >> $GITHUB_OUTPUT
            echo "âŒ Sync script failed"
            exit 1
          fi

          # Parse report for output values
          if [ -f "sync-report.json" ]; then
            commands=$(python3 -c "import json; d=json.load(open('sync-report.json')); print(d.get('commands_transformed', 0))")
            agents=$(python3 -c "import json; d=json.load(open('sync-report.json')); print(d.get('agents_transformed', 0))")
            echo "commands-transformed=$commands" >> $GITHUB_OUTPUT
            echo "agents-transformed=$agents" >> $GITHUB_OUTPUT
            echo "ðŸ“Š Commands transformed: $commands"
            echo "ðŸ“Š Agents transformed: $agents"
          fi

          # Check if files were modified (skip for dry run)
          if [ "${{ inputs.dry_run }}" != "true" ]; then
            if git diff --quiet && git diff --cached --quiet; then
              echo "files-modified=false" >> $GITHUB_OUTPUT
              echo "âœ… No changes detected - plugin is already up to date"
            else
              echo "files-modified=true" >> $GITHUB_OUTPUT
              modified_count=$(git diff --name-only | wc -l)
              echo "ðŸ“ $modified_count file(s) modified"
            fi
          else
            echo "files-modified=false" >> $GITHUB_OUTPUT
          fi

      - name: "ðŸ“Š Upload sync report"
        if: always() && hashFiles('sync-report.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: sync-report-${{ github.run_number }}
          path: sync-report.json
          retention-days: 30

      - name: "ðŸ’¾ Commit and push changes"
        if: steps.sync.outputs.files-modified == 'true' && inputs.dry_run != true
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            chore: sync from SuperClaude_Framework

            Automated sync: ${{ steps.sync.outputs.commands-transformed }} commands, ${{ steps.sync.outputs.agents-transformed }} agents transformed.
            Namespace isolation applied (sc: prefix for commands, sc- prefix for files).

            ðŸ¤– Generated by GitHub Actions
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          commit_options: '--no-verify'

      - name: "ðŸ“‹ Generate step summary"
        if: always()
        run: |
          echo "# ðŸ”„ Framework Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "## ðŸ” Dry Run Mode" >> $GITHUB_STEP_SUMMARY
            echo "Changes were previewed but NOT applied." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ steps.sync.outputs.sync-success == 'true' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commands transformed | ${{ steps.sync.outputs.commands-transformed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Agents transformed | ${{ steps.sync.outputs.agents-transformed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Files modified | ${{ steps.sync.outputs.files-modified }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Source: [SuperClaude_Framework](https://github.com/SuperClaude-Org/SuperClaude_Framework)*" >> $GITHUB_STEP_SUMMARY

  # Job 2: Validate plugin structure (runs in parallel)
  validate-plugin:
    name: "Validate plugin structure"
    runs-on: ubuntu-latest

    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4

      - name: "ðŸ” Validate plugin.json"
        run: |
          if [ ! -f "plugin.json" ]; then
            echo "âŒ Error: plugin.json not found in repository root"
            exit 1
          fi
          echo "âœ… plugin.json exists"

          if ! python3 -m json.tool plugin.json > /dev/null; then
            echo "âŒ Error: plugin.json contains invalid JSON"
            exit 1
          fi
          echo "âœ… plugin.json is valid JSON"

      - name: "ðŸ” Validate marketplace.json"
        run: |
          if [ ! -f ".claude-plugin/marketplace.json" ]; then
            echo "âŒ Error: marketplace.json not found"
            exit 1
          fi
          echo "âœ… marketplace.json exists"

          if ! python3 -m json.tool .claude-plugin/marketplace.json > /dev/null; then
            echo "âŒ Error: marketplace.json contains invalid JSON"
            exit 1
          fi
          echo "âœ… marketplace.json is valid JSON"

      - name: "ðŸ” Check command count"
        run: |
          expected_count=25
          actual_count=$(find commands -name "*.md" | wc -l)

          echo "Expected: $expected_count commands"
          echo "Actual:   $actual_count commands"

          if [ "$actual_count" -ne "$expected_count" ]; then
            echo "âš ï¸  Warning: Command count mismatch (expected $expected_count, got $actual_count)"
            echo "Please update expected_count in this workflow if the command count changed intentionally"
          else
            echo "âœ… Command count matches expected value"
          fi

  # Job 3: Summary (depends on both jobs)
  summary:
    name: "Pipeline summary"
    runs-on: ubuntu-latest
    needs: [sync-framework, validate-plugin]
    if: always()

    steps:
      - name: "ðŸ“Š Generate final summary"
        run: |
          echo "# ðŸŽ¯ Framework Sync Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.sync-framework.result }}" == "success" ]; then
            echo "âœ… **Sync**: Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Sync**: ${{ needs.sync-framework.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.validate-plugin.result }}" == "success" ]; then
            echo "âœ… **Validation**: Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Validation**: ${{ needs.validate-plugin.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Sync Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Files modified**: ${{ needs.sync-framework.outputs.files-modified }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commands transformed**: ${{ needs.sync-framework.outputs.commands-transformed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Agents transformed**: ${{ needs.sync-framework.outputs.agents-transformed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Automated sync from [SuperClaude_Framework](https://github.com/SuperClaude-Org/SuperClaude_Framework) â€” runs hourly*" >> $GITHUB_STEP_SUMMARY
